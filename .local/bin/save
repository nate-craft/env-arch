#!/usr/bin/env sh

# USB UUID for backing up

USB="DC95-5829"
ENV="${HOME}/Env"
ENV_CONF="${ENV}/.config/"
ENV_LOCAL="${ENV}/.local/"

cache_conf() {
    rsync -a --mkpath --ignore-missing-args "${HOME}/.config/${1}" "$ENV_CONF" || panic "Could not sync ${1}"
}

msg_err() {    
    printf "%s%s%s\n" "$(tput setaf 1)" "$@" "$(tput sgr0)"
}

panic() {
    msg_err "$@"
    exit 1
}

if [ ! -d "$ENV" ]; then
    printf "Cloning into Environment remote repository\n"
    git clone git@github.com:nate-craft/env-arch.git "$ENV" || panic "Could not clone into repository"
else
    cd "$ENV" || panic "Could not move into ${ENV}"
    printf "Updating local repository\n"
    git pull origin main || panic "Could not update local '$ENV' directory from remote repository"
fi

rsync -a --mkpath --ignore-missing-args "${HOME}/.local/bin" "$ENV_LOCAL" || panic "Could not sync ${HOME}/.local/bin"

cache_conf "mimeapps.list"
cache_conf "electron-flags.conf"
cache_conf "tmux"
cache_conf "helix"
cache_conf "foot"
cache_conf "yazi"
cache_conf "fish"
cache_conf "yt-dlp"
cache_conf "yt-feeds"
cache_conf "auditorium"
cache_conf "mpv"
cache_conf "sway"
cache_conf "waybar"
cache_conf "rofi"
cache_conf "dunst"
cache_conf "gammastep"

rsync -a --mkpath --ignore-missing-args "${HOME}/.config/FreeTube" \
    --exclude "Cache/" \
    --exclude "**/LOG" \
    --exclude "**/LOG.old" \
    --exclude "blob_storage" \
    --exclude "SingletonSocket" \
    --exclude "SingletonCookie" \
    --exclude "SingletonLock" \
    --exclude "Network Persistent State" \
    --exclude "subscription-cache.db" \
    --exclude "DawnGraphiteCache" \
    --exclude "DawnWebGPUCache" \
    --exclude "GPUCache" \
    --exclude "Code Cache" \
    --exclude "player_cache" \
    "$ENV_CONF" || panic "Could not sync ${HOME}/.config/FreeTube"

rsync -a --mkpath --ignore-missing-args "${HOME}/.config/calibre" \
    --exclude "viewer-webengine.json" \
    --exclude "dynamic.pickle.json" \
    --exclude "global.py.json" \
    --exclude "gui.json" \
    "$ENV_CONF" || panic "Could not sync ${HOME}/.config/calibre"

# system files to env

rsync -a --mkpath --ignore-missing-args /etc/fonts/local.conf ~/Env/etc/fonts/ || panic "Could not sync /etc/fonts/local.conf"

# backs up any data stored locally to Github

(
    cd "$ENV"
    git add .
    git commit -m "$(date --rfc-3339 s)"
    git remote set-url origin git@github.com:nate-craft/env-arch.git
    git push --force origin main
) || panic "Could not push changes to remote repository"
 
# backs up any data stored locally to USB
# Used for large + private files and Env backup

if lsblk -o UUID | rg -q "$USB"; then
    rsync --temp-dir=/tmp -rltD --mkpath --no-links --modify-window=2 --partial --info=progress2 "$ENV" /mnt/drive/
    
    # Large Files
    rsync --temp-dir=/tmp -rltD --mkpath --no-links --modify-window=2 --partial --info=progress2 "${HOME}/Documents" /mnt/drive/
    rsync --temp-dir=/tmp -rltD --mkpath --no-links --modify-window=2 --partial --info=progress2 "${HOME}/Music" /mnt/drive/
    rsync --temp-dir=/tmp -rltD --mkpath --no-links --modify-window=2 --partial --info=progress2 "${HOME}/Photos" /mnt/drive/

    # Env
    rsync --temp-dir=/tmp -rltD --mkpath --no-links --modify-window=2 --partial --info=progress2 "$ENV" /mnt/drive/ \
        --exclude ".git/"

    # SSH
    rsync --temp-dir=/tmp -rltD --mkpath --no-links --modify-window=2 --partial --info=progress2 \
        "${HOME}/.ssh" /mnt/drive/
        
    # GPG
    rsync --temp-dir=/tmp -rltD --mkpath --no-links --modify-window=2 --partial --info=progress2 \
        "${HOME}/.config/gnupg" /mnt/drive/.config/

    # Signal
    rsync --temp-dir=/tmp -rltD --mkpath --no-links --modify-window=2 --partial --info=progress2 \
        "${HOME}/.local/share/gurk" /mnt/drive/.local/share/
        
    # TOTP        
    rsync --temp-dir=/tmp -rltD --mkpath --no-links --modify-window=2 --partial --info=progress2 \
        ~/.local/share/cotp /mnt/drive/.local/share/

    # Bookmarks
    rsync --temp-dir=/tmp -rltD --mkpath --no-links --modify-window=2 --partial --info=progress2 \
        ~/.local/share/dashi /mnt/drive/.local/share/

    # Librewolf
    rsync --temp-dir=/tmp -rltD --mkpath --no-links --modify-window=2 --partial --info=progress2 \
        ~/.librewolf /mnt/drive/     
else
    msg_err "USB ${USB} not available. Not backing up to external drive..."    
fi

if [ "$1" = "--clean" ]; then
    rm -rf "$ENV" || panic "Failed to clean local repository"
    printf "Cleaned up local directory\n"
else
    printf "Synced remote repository. Use 'save --clean' to clean local directories when syncing\n"
fi



